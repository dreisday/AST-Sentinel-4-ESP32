blueprint:
  name: Intercom Notification with Unlock Button
  description: >
    Sends a push notification when the intercom rings. Tapping the action button triggers a specified button entity.
  domain: automation
  input:
    intercom_sensor:
      name: Intercom Status Sensor
      selector:
        entity:
          domain: sensor
    target_device:
      name: Mobile App Device
      selector:
        device:
          integration: mobile_app
    notify_group:
      name: Notify Group (optional)
      description: Optional notify group to override the mobile device
      default: ""
      selector:
        text:
    dashboard_path:
      name: Lovelace View Path
      default: "/lovelace/security"
    unlock_button:
      name: Button to Press
      selector:
        entity:
          domain: button
    critical_notification:
      name: Send Critical Notification
      default: true
      selector:
        boolean: {}

mode: single

trigger:
  - platform: state
    entity_id: !input intercom_sensor
    to: "ringing"

action:
  - variables:
      device_name_clean: >
        {{ device_attr(target_device, 'name') | lower | replace(" ", "_") | replace("'", "") }}
      notify_target: >
        {{ iif((notify_group | trim) != '', notify_group, "notify.mobile_app_" ~ device_name_clean) }}

  - service: "{{ notify_target }}"
    data:
      title: "Intercom Ringing"
      message: "Someone is at the door. Tap to unlock."
      data:
        url: !input dashboard_path
        push:
          sound:
            name: default
            critical: "{{ iif(input.critical_notification, 1, 0) }}"
            volume: 1.0
          badge: 1
          priority: high
          ttl: 30
          expiration: 30
        actions:
          - action: UNLOCK_INTERCOM
            title: "Unlock Door"

  - wait_for_trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: UNLOCK_INTERCOM
    timeout: "00:00:30"
    continue_on_timeout: false

  - service: button.press
    target:
      entity_id: !input unlock_button
